{
  "permissions": {
    "allow": [
      "Bash(cat:*)",
      "Bash(python -c \"\ncontent = ''''''#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\"\"\"\"\"\"\nQlib 数据自动更新脚本 - 使用 akshare 数据源\n\n功能:\n    - 自动检测现有数据的最新日期\n    - 增量下载个股日线数据\n    - 同步更新指数数据（沪深300、中证500、中证1000等）\n    - 数据标准化并转换为 qlib bin 格式\n\n使用方法:\n    python auto_update.py                    # 增量更新到最新\n    python auto_update.py --full             # 全量更新（从2010年开始）\n    python auto_update.py --start 2024-01-01 # 从指定日期开始更新\n\n依赖:\n    pip install akshare pandas loguru tqdm\n\nAuthor: Auto-generated for Qlib\n\"\"\"\"\"\"\n\nimport os\nimport sys\nimport time\nimport datetime\nimport argparse\nimport multiprocessing\nfrom pathlib import Path\nfrom typing import List, Optional, Tuple\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\n\nimport pandas as pd\nimport numpy as np\nfrom tqdm import tqdm\nfrom loguru import logger\n\ntry:\n    import akshare as ak\nexcept ImportError:\n    raise ImportError(\"\"请先安装 akshare: pip install akshare\"\")\n\n# 添加 qlib scripts 路径\nSCRIPT_DIR = Path(__file__).resolve().parent\nsys.path.insert(0, str(SCRIPT_DIR))\n\ntry:\n    import qlib\n    from qlib.data import D\nexcept ImportError:\n    qlib = None\n    D = None\n\n# ================= 配置区域 =================\n# 默认 qlib 数据目录\nDEFAULT_QLIB_DATA_DIR = Path.home() / \"\".qlib\"\" / \"\"qlib_data\"\" / \"\"cn_data\"\"\n\n# 数据起始日期（全量更新时使用）\nDEFAULT_START_DATE = \"\"2010-01-01\"\"\n\n# 指数配置: {指数名称: (akshare代码, qlib符号)}\nINDEX_CONFIG = {\n    \"\"csi300\"\": (\"\"000300\"\", \"\"sh000300\"\"),      # 沪深300\n    \"\"csi500\"\": (\"\"000905\"\", \"\"sh000905\"\"),      # 中证500\n    \"\"csi1000\"\": (\"\"000852\"\", \"\"sh000852\"\"),     # 中证1000\n    \"\"csi100\"\": (\"\"000903\"\", \"\"sh000903\"\"),      # 中证100\n    \"\"sse50\"\": (\"\"000016\"\", \"\"sh000016\"\"),       # 上证50\n}\n\n# 并发下载配置\nMAX_WORKERS = 4\nDOWNLOAD_DELAY = 0.1  # 下载间隔（秒），避免请求过快被限制\n# ===========================================\n\n\nclass AkShareDataCollector:\n    \"\"\"\"\"\"使用 akshare 收集股票数据\"\"\"\"\"\"\n\n    def __init__(\n        self,\n        qlib_data_dir: Path,\n        start_date: str = None,\n        end_date: str = None,\n        max_workers: int = MAX_WORKERS,\n    ):\n        self.qlib_data_dir = Path(qlib_data_dir)\n        self.start_date = start_date or DEFAULT_START_DATE\n        self.end_date = end_date or datetime.date.today().strftime(\"\"%Y-%m-%d\"\")\n        self.max_workers = max_workers\n\n        # 创建临时目录\n        self.source_dir = self.qlib_data_dir / \"\"_temp_source\"\"\n        self.normalize_dir = self.qlib_data_dir / \"\"_temp_normalize\"\"\n        self.source_dir.mkdir(parents=True, exist_ok=True)\n        self.normalize_dir.mkdir(parents=True, exist_ok=True)\n\n    def get_stock_list(self) -> List[str]:\n        \"\"\"\"\"\"获取A股股票列表\"\"\"\"\"\"\n        logger.info(\"\"获取A股股票列表...\"\")\n        try:\n            # 获取沪深A股列表\n            df_sh = ak.stock_sh_a_spot_em()\n            df_sz = ak.stock_sz_a_spot_em()\n\n            sh_codes = df_sh[\"\"代码\"\"].tolist() if \"\"代码\"\" in df_sh.columns else []\n            sz_codes = df_sz[\"\"代码\"\"].tolist() if \"\"代码\"\" in df_sz.columns else []\n\n            # 转换为 qlib 格式: sh600000, sz000001\n            symbols = []\n            for code in sh_codes:\n                if code.startswith((\"\"6\"\", \"\"688\"\")):  # 主板和科创板\n                    symbols.append(f\"\"sh{code}\"\")\n            for code in sz_codes:\n                if code.startswith((\"\"0\"\", \"\"3\"\")):  # 主板和创业板\n                    symbols.append(f\"\"sz{code}\"\")\n\n            logger.info(f\"\"共获取 {len(symbols)} 只股票\"\")\n            return sorted(symbols)\n        except Exception as e:\n            logger.error(f\"\"获取股票列表失败: {e}\"\")\n            # 备用方案: 从现有 qlib 数据获取\n            return self._get_symbols_from_qlib()\n\n    def _get_symbols_from_qlib(self) -> List[str]:\n        \"\"\"\"\"\"从现有 qlib 数据获取股票列表\"\"\"\"\"\"\n        instruments_file = self.qlib_data_dir / \"\"instruments\"\" / \"\"all.txt\"\"\n        if instruments_file.exists():\n            df = pd.read_csv(instruments_file, sep=\"\"\\t\"\", header=None, names=[\"\"symbol\"\", \"\"start\"\", \"\"end\"\"])\n            return df[\"\"symbol\"\"].str.lower().tolist()\n        return []\n\n    def download_stock_data(self, symbol: str) -> Optional[pd.DataFrame]:\n        \"\"\"\"\"\"下载单只股票的日线数据\"\"\"\"\"\"\n        try:\n            # 解析股票代码\n            market = symbol[:2].upper()\n            code = symbol[2:]\n\n            # 使用 akshare 获取数据\n            # 沪深京A股日线数据（东方财富）\n            df = ak.stock_zh_a_hist(\n                symbol=code,\n                period=\"\"daily\"\",\n                start_date=self.start_date.replace(\"\"-\"\", \"\"\"\"),\n                end_date=self.end_date.replace(\"\"-\"\", \"\"\"\"),\n                adjust=\"\"qfq\"\"  # 前复权\n            )\n\n            if df is None or df.empty:\n                return None\n\n            # 标准化列名\n            df = df.rename(columns={\n                \"\"日期\"\": \"\"date\"\",\n                \"\"开盘\"\": \"\"open\"\",\n                \"\"收盘\"\": \"\"close\"\",\n                \"\"最高\"\": \"\"high\"\",\n                \"\"最低\"\": \"\"low\"\",\n                \"\"成交量\"\": \"\"volume\"\",\n                \"\"成交额\"\": \"\"amount\"\",\n                \"\"振幅\"\": \"\"amplitude\"\",\n                \"\"涨跌幅\"\": \"\"pct_change\"\",\n                \"\"涨跌额\"\": \"\"change\"\",\n                \"\"换手率\"\": \"\"turnover\"\",\n            })\n\n            # 选择需要的列\n            required_cols = [\"\"date\"\", \"\"open\"\", \"\"close\"\", \"\"high\"\", \"\"low\"\", \"\"volume\"\"]\n            df = df[[c for c in required_cols if c in df.columns]]\n\n            # 添加符号列\n            df[\"\"symbol\"\"] = symbol.upper()\n\n            # 日期格式化\n            df[\"\"date\"\"] = pd.to_datetime(df[\"\"date\"\"])\n\n            return df\n\n        except Exception as e:\n            logger.debug(f\"\"下载 {symbol} 失败: {e}\"\")\n            return None\n\n    def download_index_data(self, index_code: str, symbol: str) -> Optional[pd.DataFrame]:\n        \"\"\"\"\"\"下载指数日线数据\"\"\"\"\"\"\n        try:\n            df = ak.stock_zh_index_daily(symbol=f\"\"sh{index_code}\"\")\n\n            if df is None or df.empty:\n                return None\n\n            # 标准化列名\n            df = df.rename(columns={\n                \"\"date\"\": \"\"date\"\",\n                \"\"open\"\": \"\"open\"\",\n                \"\"close\"\": \"\"close\"\",\n                \"\"high\"\": \"\"high\"\",\n                \"\"low\"\": \"\"low\"\",\n                \"\"volume\"\": \"\"volume\"\",\n            })\n\n            # 日期过滤\n            df[\"\"date\"\"] = pd.to_datetime(df[\"\"date\"\"])\n            df = df[(df[\"\"date\"\"] >= pd.Timestamp(self.start_date)) &\n                    (df[\"\"date\"\"] <= pd.Timestamp(self.end_date))]\n\n            df[\"\"symbol\"\"] = symbol.upper()\n\n            required_cols = [\"\"date\"\", \"\"open\"\", \"\"close\"\", \"\"high\"\", \"\"low\"\", \"\"volume\"\", \"\"symbol\"\"]\n            df = df[[c for c in required_cols if c in df.columns]]\n\n            return df\n\n        except Exception as e:\n            logger.error(f\"\"下载指数 {index_code} 失败: {e}\"\")\n            return None\n\n    def normalize_data(self, df: pd.DataFrame) -> pd.DataFrame:\n        \"\"\"\"\"\"标准化数据为 qlib 格式\"\"\"\"\"\"\n        if df is None or df.empty:\n            return pd.DataFrame()\n\n        df = df.copy()\n\n        # 确保日期格式\n        df[\"\"date\"\"] = pd.to_datetime(df[\"\"date\"\"])\n\n        # 移除重复数据\n        df = df.drop_duplicates(subset=[\"\"date\"\"], keep=\"\"last\"\")\n\n        # 按日期排序\n        df = df.sort_values(\"\"date\"\")\n\n        # 计算复权因子和涨跌幅\n        if \"\"close\"\" in df.columns:\n            df[\"\"factor\"\"] = 1.0  # akshare 已经是复权数据\n            df[\"\"change\"\"] = df[\"\"close\"\"].pct_change()\n\n        # 处理无效数据\n        df.loc[(df[\"\"volume\"\"] <= 0) | df[\"\"volume\"\"].isna(),\n               [\"\"open\"\", \"\"high\"\", \"\"low\"\", \"\"close\"\", \"\"volume\"\"]] = np.nan\n\n        return df\n\n    def save_to_csv(self, df: pd.DataFrame, symbol: str):\n        \"\"\"\"\"\"保存数据到 CSV 文件\"\"\"\"\"\"\n        if df is None or df.empty:\n            return\n\n        file_path = self.normalize_dir / f\"\"{symbol.upper()}.csv\"\"\n\n        # 如果文件存在，合并数据\n        if file_path.exists():\n            old_df = pd.read_csv(file_path)\n            old_df[\"\"date\"\"] = pd.to_datetime(old_df[\"\"date\"\"])\n            df = pd.concat([old_df, df], ignore_index=True)\n            df = df.drop_duplicates(subset=[\"\"date\"\"], keep=\"\"last\"\")\n            df = df.sort_values(\"\"date\"\")\n\n        df.to_csv(file_path, index=False)\n\n    def collect_all_stocks(self, symbols: List[str] = None):\n        \"\"\"\"\"\"收集所有股票数据\"\"\"\"\"\"\n        if symbols is None:\n            symbols = self.get_stock_list()\n\n        logger.info(f\"\"开始下载 {len(symbols)} 只股票数据...\"\")\n\n        success_count = 0\n        failed_symbols = []\n\n        with tqdm(total=len(symbols), desc=\"\"下载股票数据\"\") as pbar:\n            for symbol in symbols:\n                df = self.download_stock_data(symbol)\n                if df is not None and not df.empty:\n                    df = self.normalize_data(df)\n                    self.save_to_csv(df, symbol)\n                    success_count += 1\n                else:\n                    failed_symbols.append(symbol)\n\n                pbar.update(1)\n                time.sleep(DOWNLOAD_DELAY)\n\n        logger.info(f\"\"下载完成: 成功 {success_count}, 失败 {len(failed_symbols)}\"\")\n        if failed_symbols and len(failed_symbols) <= 20:\n            logger.warning(f\"\"失败的股票: {failed_symbols}\"\")\n\n    def collect_all_indices(self):\n        \"\"\"\"\"\"收集所有指数数据\"\"\"\"\"\"\n        logger.info(\"\"开始下载指数数据...\"\")\n\n        for name, (code, symbol) in INDEX_CONFIG.items():\n            logger.info(f\"\"下载 {name} ({symbol})...\"\")\n            df = self.download_index_data(code, symbol)\n            if df is not None and not df.empty:\n                df = self.normalize_data(df)\n                self.save_to_csv(df, symbol)\n                logger.info(f\"\"{name} 下载成功\"\")\n            else:\n                logger.warning(f\"\"{name} 下载失败\"\")\n            time.sleep(DOWNLOAD_DELAY)\n\n    def dump_to_bin(self):\n        \"\"\"\"\"\"转换数据为 qlib bin 格式\"\"\"\"\"\"\n        logger.info(\"\"转换数据为 qlib bin 格式...\"\")\n\n        try:\n            from dump_bin import DumpDataUpdate\n\n            _dump = DumpDataUpdate(\n                data_path=str(self.normalize_dir),\n                qlib_dir=str(self.qlib_data_dir),\n                exclude_fields=\"\"symbol,date\"\",\n                max_workers=max(multiprocessing.cpu_count() - 2, 1),\n            )\n            _dump.dump()\n            logger.info(\"\"数据转换完成\"\")\n        except Exception as e:\n            logger.error(f\"\"数据转换失败: {e}\"\")\n            raise\n\n    def cleanup(self):\n        \"\"\"\"\"\"清理临时文件\"\"\"\"\"\"\n        import shutil\n        try:\n            if self.source_dir.exists():\n                shutil.rmtree(self.source_dir)\n            if self.normalize_dir.exists():\n                shutil.rmtree(self.normalize_dir)\n            logger.info(\"\"临时文件清理完成\"\")\n        except Exception as e:\n            logger.warning(f\"\"清理临时文件失败: {e}\"\")\n\n\ndef get_last_date(qlib_data_dir: Path) -> str:\n    \"\"\"\"\"\"获取当前数据库中最新的交易日\"\"\"\"\"\"\n    try:\n        if qlib is not None and D is not None:\n            qlib.init(provider_uri=str(qlib_data_dir))\n            # 从日历文件获取最新日期\n            calendar_file = qlib_data_dir / \"\"calendars\"\" / \"\"day.txt\"\"\n            if calendar_file.exists():\n                df = pd.read_csv(calendar_file, header=None)\n                last_date = pd.Timestamp(df.iloc[-1, 0])\n                return last_date.strftime(\"\"%Y-%m-%d\"\")\n\n        # 备用方案: 直接读取日历文件\n        calendar_file = qlib_data_dir / \"\"calendars\"\" / \"\"day.txt\"\"\n        if calendar_file.exists():\n            df = pd.read_csv(calendar_file, header=None)\n            last_date = pd.Timestamp(df.iloc[-1, 0])\n            return last_date.strftime(\"\"%Y-%m-%d\"\")\n\n    except Exception as e:\n        logger.warning(f\"\"无法读取现有数据日期: {e}\"\")\n\n    # 默认回溯7天\n    return (datetime.date.today() - datetime.timedelta(days=7)).strftime(\"\"%Y-%m-%d\"\")\n\n\ndef is_trading_day(date: datetime.date) -> bool:\n    \"\"\"\"\"\"检查是否为交易日\"\"\"\"\"\"\n    # 周末不是交易日\n    if date.weekday() >= 5:\n        return False\n    # TODO: 可以添加节假日判断\n    return True\n\n\ndef run_update(\n    qlib_data_dir: str = None,\n    start_date: str = None,\n    end_date: str = None,\n    full_update: bool = False,\n    skip_stock: bool = False,\n    skip_index: bool = False,\n    skip_dump: bool = False,\n    cleanup: bool = True,\n):\n    \"\"\"\"\"\"\n    运行数据更新\n\n    Parameters\n    ----------\n    qlib_data_dir : str\n        qlib 数据目录\n    start_date : str\n        开始日期，格式 YYYY-MM-DD\n    end_date : str\n        结束日期，格式 YYYY-MM-DD\n    full_update : bool\n        是否全量更新\n    skip_stock : bool\n        是否跳过股票数据\n    skip_index : bool\n        是否跳过指数数据\n    skip_dump : bool\n        是否跳过 bin 转换\n    cleanup : bool\n        是否清理临时文件\n    \"\"\"\"\"\"\n    # 确定数据目录\n    if qlib_data_dir is None:\n        qlib_data_dir = DEFAULT_QLIB_DATA_DIR\n    qlib_data_dir = Path(qlib_data_dir)\n\n    if not qlib_data_dir.exists():\n        logger.error(f\"\"数据目录不存在: {qlib_data_dir}\"\")\n        logger.info(\"\"请先下载 qlib 初始数据，或指定正确的数据目录\"\")\n        return\n\n    # 确定日期范围\n    if full_update:\n        start_date = DEFAULT_START_DATE\n    elif start_date is None:\n        # 增量更新: 从最后一天开始\n        last_date = get_last_date(qlib_data_dir)\n        # 往前多取几天确保数据完整\n        start_date = (pd.Timestamp(last_date) - pd.Timedelta(days=3)).strftime(\"\"%Y-%m-%d\"\")\n\n    if end_date is None:\n        end_date = datetime.date.today().strftime(\"\"%Y-%m-%d\"\")\n\n    logger.info(f\"\"数据目录: {qlib_data_dir}\"\")\n    logger.info(f\"\"更新范围: {start_date} -> {end_date}\"\")\n\n    # 检查是否需要更新\n    if start_date >= end_date:\n        logger.info(\"\"数据已是最新，无需更新\"\")\n        return\n\n    # 创建收集器\n    collector = AkShareDataCollector(\n        qlib_data_dir=qlib_data_dir,\n        start_date=start_date,\n        end_date=end_date,\n    )\n\n    try:\n        # 下载股票数据\n        if not skip_stock:\n            collector.collect_all_stocks()\n\n        # 下载指数数据\n        if not skip_index:\n            collector.collect_all_indices()\n\n        # 转换为 bin 格式\n        if not skip_dump:\n            collector.dump_to_bin()\n\n        logger.info(\"\"数据更新完成!\"\")\n\n    except Exception as e:\n        logger.error(f\"\"更新失败: {e}\"\")\n        raise\n    finally:\n        # 清理临时文件\n        if cleanup:\n            collector.cleanup()\n\n\ndef main():\n    \"\"\"\"\"\"命令行入口\"\"\"\"\"\"\n    parser = argparse.ArgumentParser(\n        description=\"\"Qlib 数据自动更新脚本 (akshare 数据源)\"\",\n        formatter_class=argparse.RawDescriptionHelpFormatter,\n    )\n\n    parser.add_argument(\n        \"\"--qlib_data_dir\"\",\n        type=str,\n        default=None,\n        help=f\"\"qlib 数据目录 (默认: {DEFAULT_QLIB_DATA_DIR})\"\",\n    )\n    parser.add_argument(\n        \"\"--start\"\",\n        type=str,\n        default=None,\n        help=\"\"开始日期 (YYYY-MM-DD)\"\",\n    )\n    parser.add_argument(\n        \"\"--end\"\",\n        type=str,\n        default=None,\n        help=\"\"结束日期 (YYYY-MM-DD)\"\",\n    )\n    parser.add_argument(\n        \"\"--full\"\",\n        action=\"\"store_true\"\",\n        help=\"\"全量更新 (从2010年开始)\"\",\n    )\n    parser.add_argument(\n        \"\"--skip-stock\"\",\n        action=\"\"store_true\"\",\n        help=\"\"跳过股票数据下载\"\",\n    )\n    parser.add_argument(\n        \"\"--skip-index\"\",\n        action=\"\"store_true\"\",\n        help=\"\"跳过指数数据下载\"\",\n    )\n    parser.add_argument(\n        \"\"--skip-dump\"\",\n        action=\"\"store_true\"\",\n        help=\"\"跳过 bin 格式转换\"\",\n    )\n    parser.add_argument(\n        \"\"--no-cleanup\"\",\n        action=\"\"store_true\"\",\n        help=\"\"不清理临时文件\"\",\n    )\n    parser.add_argument(\n        \"\"--debug\"\",\n        action=\"\"store_true\"\",\n        help=\"\"启用调试模式\"\",\n    )\n\n    args = parser.parse_args()\n\n    # 配置日志\n    if args.debug:\n        logger.remove()\n        logger.add(sys.stderr, level=\"\"DEBUG\"\")\n    else:\n        logger.remove()\n        logger.add(sys.stderr, level=\"\"INFO\"\")\n\n    # 运行更新\n    run_update(\n        qlib_data_dir=args.qlib_data_dir,\n        start_date=args.start,\n        end_date=args.end,\n        full_update=args.full,\n        skip_stock=args.skip_stock,\n        skip_index=args.skip_index,\n        skip_dump=args.skip_dump,\n        cleanup=not args.no_cleanup,\n    )\n\n\nif __name__ == \"\"__main__\"\":\n    main()\n''''''\nwith open(''D:/Code_new/Finance/qlib/scripts/auto_update.py'', ''w'', encoding=''utf-8'') as f:\n    f.write(content)\nprint(''File written successfully'')\n\")",
      "Bash(python:*)",
      "Bash(mkdir:*)"
    ]
  }
}
